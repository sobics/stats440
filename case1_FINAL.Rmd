---
title: "case1_FINAL"
author: "Sonia Xu"
date: "September 18, 2017"
output: html_document
---

```{r include = F}
library(dplyr)
library(lme4)
library(ggplot2)
#read in the data
###plot multiple ggplots in one place  obtained from http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

RMSE <- function(x,y) {return(sqrt(mean((y-x)^2)))} 
dat <- read.table("case1.txt", header = T, stringsAsFactors = F, na.strings = ".", colClasses=c("character","character","numeric","numeric","numeric","numeric","numeric","numeric"))
dat <-  dat %>% filter(complete.cases(blot)) %>% mutate(wblot = blot/body, wwet = wet/body)
```

#Introduction
The following data is from an international validation study (19 labs, 6 nations) of the rat uterotrophic bioassay. The purpose of the assay was to screen chemicals for estrogenic effects--agonist (EE) or antagonist (ZM). One clear challenge from the assay was the consistency among variables and protocols throughout all data in the study. The motivation of this study is to fit the best model against the data to identify potential differences between labs, and to assess the consistency and effectiveness of the two chemicals. 
```{r}
```

#Data
Our final dataset contains 2677 observations and 6 features: lab, protocol, dose 1, dose 2, body weight, blotted uterus weight. 
```{r}
```


#Exploratory Data Analysis
[show plot of dose1 and discuss the high leverage of the outliers] It is critical to counter the leverage in our regression model - we use log(dose1) in our model to fix this. After doing the log of dose1, we notice that it is not exactly linear and include a polynomial to better fit the model.
```{r}
mean_dat1 <- dat %>% group_by(lab, dose1) %>% summarise(blot = mean(blot))
d1_graph <- ggplot(data = mean_dat1, aes(x = dose1, y = blot, color = lab)) + geom_line() + ggtitle("Dose 1")
mean_dat2 <- dat %>% group_by(lab, dose2) %>% summarise(blot = mean(blot))
d2_graph <- ggplot(data = mean_dat2, aes(x = dose2, y = blot, color = lab)) + geom_line() + ggtitle("Dose 2")

multiplot(d1_graph, d2_graph, cols = 2)
```
```

#Final Model
```{r}
fm1 <- lmer(log(blot+1) ~ (1 + poly(log(dose1 + 1),2) + poly(log(dose2 + 1),2) |lab) + poly(log(dose1 + 1),2) + poly(log(dose2+1),2) + poly(log(body),2) + (proto*lab), dat)
```

#Discussion of Final Model
```{r}
```
-normality
-residuals
-every linear check possible

#Recommendations
```{r}
```
